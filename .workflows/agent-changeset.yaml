# Changeset Agent Workflow
# Analyzes merged PRs to determine changeset needs

agents:
  changeset_analyzer:
    model: deepseek:deepseek-chat
    backend: sdk
    system_prompt: |
      You are a changeset analyzer for a monorepo using changesets.
      You analyze merged PRs and determine which packages need version bumps.
      You produce structured JSON output — you do NOT create branches, PRs, or run git commands.

      Version bump guidelines:
      - patch: bug fixes, documentation updates, internal refactors
      - minor: new features, new exports (backward compatible)
      - major: breaking changes, removed APIs, changed behavior

      **IMPORTANT - 0.x Development Phase:**
      - This project is in 0.x development (pre-1.0)
      - During 0.x: ALWAYS use "minor" for breaking changes (NOT "major")
      - This keeps versions in 0.x range (e.g., 0.4.0 -> 0.5.0, NOT 1.0.0)

      Look for keywords: "BREAKING", "breaking change", "feat:", "fix:", etc.
      Only "semajsx" package needs versioning (the main unified package).

context:
  provider: memory

setup:
  - shell: echo "$PR_NUMBER"
    as: pr_number

  - shell: echo "$GITHUB_REPOSITORY"
    as: repo

  # Get PR information
  - shell: |
      gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" \
        --json title,body,author,labels,commits \
        --jq '{
          title: .title,
          body: .body,
          author: .author.login,
          labels: [.labels[].name],
          commits: [.commits[] | {message: .messageHeadline, messageBody: .messageBody}]
        }'
    as: pr_info

  # Get changed files
  - shell: |
      gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" \
        --json files --jq '.files[].path'
    as: changed_files

  # Check for existing changesets in the merged PR
  - shell: |
      CHANGESETS=$(gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" \
        --json files --jq '[.files[] | select(.path | startswith(".changeset/")) | .path] | length')
      if [ "$CHANGESETS" -gt 0 ]; then
        echo "true"
      else
        echo "false"
      fi
    as: has_existing_changeset

  # Package info
  - shell: |
      jq -r '.name' packages/semajsx/package.json 2>/dev/null
    as: package_name

kickoff: |
  @changeset_analyzer Analyze merged PR #${{ pr_number }} and determine if a changeset is needed.

  ## Context

  **Has existing changeset in PR**: ${{ has_existing_changeset }}

  ## PR Information
  ```json
  ${{ pr_info }}
  ```

  ## Changed Files
  ```
  ${{ changed_files }}
  ```

  ## Package
  ```
  ${{ package_name }}
  ```

  ## Instructions

  1. If `has_existing_changeset` is `true`, the PR already included a changeset. Write:
     ```bash
     cat > /tmp/changeset-result.json << 'EOF'
     { "needed": false, "reason": "PR already contains a changeset" }
     EOF
     ```

  2. If changes only affect non-package files (.github/, docs/, root config), write:
     ```bash
     cat > /tmp/changeset-result.json << 'EOF'
     { "needed": false, "reason": "Changes don't affect published packages" }
     EOF
     ```

  3. Otherwise, analyze the changes. View the diff if needed:
     ```bash
     gh pr diff ${{ pr_number }} --repo ${{ repo }}
     ```

     Then write your analysis:
     ```bash
     cat > /tmp/changeset-result.json << 'EOF'
     {
       "needed": true,
       "packages": {
         "semajsx": "patch|minor"
       },
       "description": "Brief description of the change for CHANGELOG"
     }
     EOF
     ```

  Rules:
  - The `packages` field must use "semajsx" (the main package)
  - The `description` field should be a concise CHANGELOG entry (one line)
  - Remember: during 0.x, use "minor" for breaking changes (not "major")
  - The JSON must be valid — the CI will parse it to create the changeset
  - You ONLY write JSON. The CI handles branch creation, versioning, and PR creation.
