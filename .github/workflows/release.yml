name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 0.1.0) or "patch"/"minor"/"major" for auto-bump'
        required: false
        default: "patch"
  push:
    branches:
      - main
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: bun install

      - name: Build packages
        run: bun run build

      - name: Determine version
        id: version
        run: |
          INPUT_VERSION="${{ github.event.inputs.version }}"
          if [[ -n "$INPUT_VERSION" ]]; then
            if [[ "$INPUT_VERSION" =~ ^(patch|minor|major)$ ]]; then
              VERSION=$(bun run -e "console.log(require('semver').inc(require('./packages/semajsx/package.json').version, '$INPUT_VERSION'))")
            else
              VERSION="$INPUT_VERSION"
            fi
          else
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
            if [[ "$VERSION" == v* ]]; then
              VERSION="${VERSION:1}"
            fi
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update version
        run: |
          cd packages/semajsx
          bun run -e "const pkg=require('./package.json');pkg.version='${{ steps.version.outputs.version }}';require('fs').writeFileSync('./package.json',JSON.stringify(pkg,null,2)+'\n')"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Publish to npm
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd packages/semajsx
          npm publish --access public

      - name: Create GitHub tag
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            --title "semajsx v${{ steps.version.outputs.version }}" \
            --generate-notes \
            --latest
